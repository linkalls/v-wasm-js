{"version":3,"file":"server.mjs","names":[],"sources":["../src/server/render.ts","../src/server/render-async.ts"],"sourcesContent":["import type { VNode, ComponentDescriptor, ServerElement, Child } from '../jsx-runtime';\n\nconst voidTags = new Set([\n  'area', 'base', 'br', 'col', 'embed', 'hr', 'img', 'input',\n  'link', 'meta', 'param', 'source', 'track', 'wbr'\n]);\n\nfunction escapeHtml(str: string): string {\n  return str\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\nexport function renderToString(node: Child): string {\n  if (node === null || node === undefined || node === false || node === true) {\n    return '';\n  }\n\n  if (typeof node === 'string' || typeof node === 'number') {\n    return escapeHtml(String(node));\n  }\n\n  if (Array.isArray(node)) {\n    return node.map(renderToString).join('');\n  }\n\n  if (typeof node === 'function') {\n    try {\n      const result = node();\n      return renderToString(result);\n    } catch (e) {\n      // Allow Suspense-style promise throwing to bubble to an async renderer.\n      if (e && typeof (e as any).then === 'function') throw e;\n      console.error('Error executing reactive function in SSR:', e);\n      return '';\n    }\n  }\n\n  // Handle VNode objects\n  if (typeof node === 'object') {\n    // Component Descriptor\n    if ('_brand' in node && node._brand === 'component') {\n      const descriptor = node as ComponentDescriptor;\n      try {\n        const result = descriptor.type(descriptor.props);\n        return renderToString(result);\n      } catch (e) {\n        if (e && typeof (e as any).then === 'function') throw e;\n        throw e;\n      }\n    }\n\n    // Server Element\n    if ('_brand' in node && node._brand === 'server-element') {\n      const el = node as ServerElement;\n      const tagName = el.type;\n      let attrs = '';\n      let innerHTML = '';\n\n      const keys = Object.keys(el.props);\n      for (const key of keys) {\n        if (key === 'children' || key === 'ref' || key.startsWith('on')) continue;\n\n        let value = el.props[key];\n\n        // Resolve reactive function if needed\n        if (typeof value === 'function') {\n          try {\n            value = value();\n          } catch {\n            value = undefined;\n          }\n        }\n\n        if (key === 'innerHTML' || key === 'textContent') {\n          // Special handling for innerHTML/textContent props\n          const val = String(value ?? '');\n          if (key === 'textContent') {\n            innerHTML = escapeHtml(val);\n          } else {\n            innerHTML = val;\n          }\n          continue;\n        }\n\n        if (value === true) {\n          attrs += ` ${key}`;\n        } else if (value !== false && value != null) {\n          if (key === 'style' && typeof value === 'object') {\n            const styleStr = Object.entries(value)\n              .map(([k, v]) => `${k.replace(/([A-Z])/g, '-$1').toLowerCase()}:${v}`)\n              .join(';');\n            attrs += ` style=\"${escapeHtml(styleStr)}\"`;\n          } else if (key === 'class' || key === 'className') {\n            attrs += ` class=\"${escapeHtml(String(value))}\"`;\n          } else {\n            attrs += ` ${key}=\"${escapeHtml(String(value))}\"`;\n          }\n        }\n      }\n\n      if (voidTags.has(tagName)) {\n        return `<${tagName}${attrs} />`;\n      }\n\n      const childrenStr = innerHTML || el.children.map(renderToString).join('');\n      return `<${tagName}${attrs}>${childrenStr}</${tagName}>`;\n    }\n\n    // Fragment (handled as array or object depending on runtime)\n    // If runtime returns DocumentFragment, we can't easily handle it here in Node env.\n    // But our modified runtime returns Array for Fragment in SSR.\n    // If strict checks fail, we might fall through here.\n  }\n\n  return '';\n}\n","import { renderToString } from './render';\nimport type { Child } from '../jsx-runtime';\n\n// Minimal async SSR: retries rendering while promises are thrown (Suspense-style).\nexport async function renderToStringAsync(node: Child): Promise<string> {\n  // avoid infinite loops\n  for (let i = 0; i < 50; i++) {\n    try {\n      return renderToString(node);\n    } catch (e) {\n      if (e && typeof (e as any).then === 'function') {\n        await e;\n        continue;\n      }\n      throw e;\n    }\n  }\n  throw new Error('renderToStringAsync exceeded retry limit (possible infinite suspense loop)');\n}\n"],"mappings":"AAEA,MAAM,EAAW,IAAI,IAAI,CACvB,OAAQ,OAAQ,KAAM,MAAO,QAAS,KAAM,MAAO,QACnD,OAAQ,OAAQ,QAAS,SAAU,QAAS,MAC7C,CAAC,CAEF,SAAS,EAAW,EAAqB,CACvC,OAAO,EACJ,QAAQ,KAAM,QAAQ,CACtB,QAAQ,KAAM,OAAO,CACrB,QAAQ,KAAM,OAAO,CACrB,QAAQ,KAAM,SAAS,CACvB,QAAQ,KAAM,SAAS,CAG5B,SAAgB,EAAe,EAAqB,CAClD,GAAI,GAAS,MAA8B,IAAS,IAAS,IAAS,GACpE,MAAO,GAGT,GAAI,OAAO,GAAS,UAAY,OAAO,GAAS,SAC9C,OAAO,EAAW,OAAO,EAAK,CAAC,CAGjC,GAAI,MAAM,QAAQ,EAAK,CACrB,OAAO,EAAK,IAAI,EAAe,CAAC,KAAK,GAAG,CAG1C,GAAI,OAAO,GAAS,WAClB,GAAI,CAEF,OAAO,EADQ,GAAM,CACQ,OACtB,EAAG,CAEV,GAAI,GAAK,OAAQ,EAAU,MAAS,WAAY,MAAM,EAEtD,OADA,QAAQ,MAAM,4CAA6C,EAAE,CACtD,GAKX,GAAI,OAAO,GAAS,SAAU,CAE5B,GAAI,WAAY,GAAQ,EAAK,SAAW,YAAa,CACnD,IAAM,EAAa,EACnB,GAAI,CAEF,OAAO,EADQ,EAAW,KAAK,EAAW,MAAM,CACnB,OACtB,EAAG,CAEV,MADI,GAAa,EAAU,KAA2B,GAM1D,GAAI,WAAY,GAAQ,EAAK,SAAW,iBAAkB,CACxD,IAAM,EAAK,EACL,EAAU,EAAG,KACf,EAAQ,GACR,EAAY,GAEV,EAAO,OAAO,KAAK,EAAG,MAAM,CAClC,IAAK,IAAM,KAAO,EAAM,CACtB,GAAI,IAAQ,YAAc,IAAQ,OAAS,EAAI,WAAW,KAAK,CAAE,SAEjE,IAAI,EAAQ,EAAG,MAAM,GAGrB,GAAI,OAAO,GAAU,WACnB,GAAI,CACF,EAAQ,GAAO,MACT,CACN,EAAQ,IAAA,GAIZ,GAAI,IAAQ,aAAe,IAAQ,cAAe,CAEhD,IAAM,EAAM,OAAO,GAAS,GAAG,CAC/B,AAGE,EAHE,IAAQ,cACE,EAAW,EAAI,CAEf,EAEd,SAGF,GAAI,IAAU,GACZ,GAAS,IAAI,YACJ,IAAU,IAAS,GAAS,KACrC,GAAI,IAAQ,SAAW,OAAO,GAAU,SAAU,CAChD,IAAM,EAAW,OAAO,QAAQ,EAAM,CACnC,KAAK,CAAC,EAAG,KAAO,GAAG,EAAE,QAAQ,WAAY,MAAM,CAAC,aAAa,CAAC,GAAG,IAAI,CACrE,KAAK,IAAI,CACZ,GAAS,WAAW,EAAW,EAAS,CAAC,QAChC,IAAQ,SAAW,IAAQ,YACpC,GAAS,WAAW,EAAW,OAAO,EAAM,CAAC,CAAC,GAE9C,GAAS,IAAI,EAAI,IAAI,EAAW,OAAO,EAAM,CAAC,CAAC,GAKrD,GAAI,EAAS,IAAI,EAAQ,CACvB,MAAO,IAAI,IAAU,EAAM,KAG7B,IAAM,EAAc,GAAa,EAAG,SAAS,IAAI,EAAe,CAAC,KAAK,GAAG,CACzE,MAAO,IAAI,IAAU,EAAM,GAAG,EAAY,IAAI,EAAQ,IAS1D,MAAO,GClHT,eAAsB,EAAoB,EAA8B,CAEtE,IAAK,IAAI,EAAI,EAAG,EAAI,GAAI,IACtB,GAAI,CACF,OAAO,EAAe,EAAK,OACpB,EAAG,CACV,GAAI,GAAK,OAAQ,EAAU,MAAS,WAAY,CAC9C,MAAM,EACN,SAEF,MAAM,EAGV,MAAU,MAAM,6EAA6E"}