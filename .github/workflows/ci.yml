name: ci

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Build toolchain for generating src/vsignal.wasm
      - name: Install V
        run: |
          git clone --depth 1 https://github.com/vlang/v vlang
          cd vlang
          make -j2
          echo "$PWD" >> $GITHUB_PATH

      - name: Install Binaryen (wasm-opt)
        run: |
          cd vlang
          ./v run ./cmd/tools/install_binaryen.vsh

          # $GITHUB_PATH becomes active in subsequent steps.
          # V's installer may place wasm-opt under thirdparty/binaryen/<binaryen-version_xxx>/bin
          BIN_DIR=""
          if [ -x "$PWD/thirdparty/binaryen/bin/wasm-opt" ]; then
            BIN_DIR="$PWD/thirdparty/binaryen/bin"
          else
            BIN_DIR=$(ls -d "$PWD"/thirdparty/binaryen*/bin 2>/dev/null | head -n 1 || true)
          fi

          echo "$BIN_DIR" >> $GITHUB_PATH
          export PATH="$BIN_DIR:$PATH"
          wasm-opt --version

      - name: Install deps
        run: bun install

      - name: Build wasm
        run: bun run build:wasm

      - name: Build
        run: bun run build

      - name: Test wasm presence
        run: bun run test:wasm

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: E2E (Playwright)
        run: bun run test:e2e
