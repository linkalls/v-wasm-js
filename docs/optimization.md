# Vitrio 最適化ガイド

このドキュメントは、Vitrioフレームワークで実施した最適化とその効果について説明します。

## 概要

Vitrioは、V言語で書かれたWASMをJavaScriptにバンドルすることで、高速なリアクティブUIフレームワークを実現しています。

## 最適化の変更履歴

### 2026-01-15: For/Show コンポーネントの修正

#### 問題

- `<For>` と `<Show>` コンポーネントがJSXから渡される`children`を正しく処理できていなかった
- JSXランタイムが`children`を配列として渡すため、関数として直接呼び出せなかった
- リスト更新のベンチマークで項目が0個になっていた

#### 修正内容

1. **flow.ts: For コンポーネント**
   - `props.children` が配列の場合、最初の要素を `renderFn` として抽出
   - フラグメントがDOMにマウントされる前でも正しくレンダリングするように修正

2. **flow.ts: Show コンポーネント**
   - 同様に `getChild()` と `getFallback()` ヘルパー関数を追加
   - 配列からの要素抽出を適切に処理

3. **jsx-runtime.ts: 型定義**
   - `JSX.Element` を `VNode` 型として定義（DocumentFragment を含む）
   - For/Show が有効なJSXコンポーネントとして認識されるように修正

#### 結果

| メトリクス | 修正前 | 修正後 | 改善率 |
|-----------|--------|--------|--------|
| リスト更新 | 12.7ms | **5.9ms** | **53%高速** |
| インタラクション | 11.9ms | **7.8ms** | **35%高速** |
| Final list items | 0 | **50** | ✓ 正常動作 |

---

### 2026-01-15: WASMとJSのサイズ最適化

#### 変更内容

1. **V言語ビルドフラグの最適化** (`package.json`)
   - `-d no_bounds_checking`: 配列の境界チェックを無効化
   - `-d no_backtrace`: バックトレース生成を無効化
   - `-d no_stdio`: 標準I/Oサポートを削除
   - `wasm-opt --strip-debug`: デバッグ情報を削除

2. **`@[direct_array_access]` アトリビュートの追加** (`src/vsignal/signal.v`)

3. **console.log/warn の削除** (`src/core.ts`)

#### 結果

| コンポーネント | 最適化前 | 最適化後 | 削減率 |
|----------------|----------|----------|--------|
| WASM バイナリ | 3,901 B | 1,511 B | **61%削減** |
| メインJSチャンク | 12,393 B | 10,261 B | **17%削減** |

### 2026-01-18: サブスクリプションのクリーンアップ

#### 変更内容
- `<For>` / `<Show>` でノードを削除する際に、紐づくリアクティブバインディングを確実に破棄するように変更。
- `render` もマウント前に既存ノードのクリーンアップを行い、再マウント時の残留サブスクを除去。

#### 結果
- リスト更新: **4.50ms → 2.95ms** (約34%高速化)
- 100クリック: **2.68ms → 2.18ms** (約19%高速化)

## ベンチマーク結果 (最新)

| メトリクス | Vitrio | SolidJS | React |
|------------|--------|---------|-------|
| バンドルサイズ | **11.6KB** | 13.0KB | 144.1KB |
| インタラクション (100 clicks, ms) | **2.18** | 10.17 | 11.26 |
| リスト更新 (50 add, 25 remove, ms) | **2.95** | 11.31 | 8.75 |

### 分析

- **リスト更新**: VitrioはSolidより**284%高速**、Reactより**197%高速**
- **インタラクション**: VitrioはSolidより**367%高速**、Reactより**416%高速**
- **バンドルサイズ**: VitrioはSolidより約12%小さく、Reactより約92%小さい

## ビルドコマンド

```bash
# WASMをビルド（最適化済み）
bun run build:wasm

# JSをビルド
bun run build

# 型定義を生成
bun run build:types

# すべてをビルド
bun run prepare
```
