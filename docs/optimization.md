# Vitrio 最適化ガイド

このドキュメントは、Vitrioフレームワークで実施した最適化とその効果について説明します。

## 概要

Vitrioは、V言語で書かれたWASMをJavaScriptにバンドルすることで、高速なリアクティブUIフレームワークを実現しています。

## 最適化の変更履歴

### 2026-01-15: WASMとJSのサイズ最適化

#### 変更内容

1. **V言語ビルドフラグの最適化** (`package.json`)
   - `-d no_bounds_checking`: 配列の境界チェックを無効化（WASMレベルで安全性が保証されるため不要）
   - `-d no_backtrace`: バックトレース生成を無効化
   - `-d no_stdio`: 標準I/Oサポートを削除
   - `wasm-opt --strip-debug`: デバッグ情報を削除

2. **`@[direct_array_access]` アトリビュートの追加** (`src/vsignal/signal.v`)
   - `add_dependency()`, `propagate()`, `get_update_buffer_ptr()` 関数に適用
   - 配列アクセスをダイレクトに行い、境界チェックのオーバーヘッドを削除

3. **console.log/warn の削除** (`src/core.ts`)
   - プロダクションビルドから不要なログ出力を削除
   - バンドルサイズの削減とランタイムオーバーヘッドの排除

#### 結果

| コンポーネント | 最適化前 | 最適化後 | 削減率 |
|----------------|----------|----------|--------|
| WASM バイナリ | 3,901 B | 1,511 B | **61%削減** |
| メインJSチャンク | 7,857 B | 4,452 B | **43%削減** |
| 合計 | ~17 KB | ~10 KB | **44%削減** |

## ベンチマーク結果

| メトリクス | Vitrio | SolidJS | React |
|------------|--------|---------|-------|
| バンドルサイズ (bytes) | 10,851 | 12,970 | 144,132 |
| ロード時間 (ms) | 54.58 | 33.10 | 45.31 |
| インタラクション 100クリック (ms) | 8.52 | 7.63 | 7.07 |
| リスト更新 (ms) | **6.71** | 8.08 | 8.55 |

### 分析

- **バンドルサイズ**: VitrioはSolidJSより16%小さく、Reactより92%小さい
- **リスト更新**: Vitrioが最速（Solidより17%高速、Reactより22%高速）
- **ロード時間**: WASMの初期化オーバーヘッドにより、純粋なJSフレームワークより遅い

## 今後の最適化候補

### ロード時間の改善

1. **WASM遅延ロード**: 最初のインタラクションまでWASMロードを遅延
2. **WASM圧縮**: gzip/brotli圧縮でダウンロードサイズを削減
3. **メモリ事前確保の最適化**: 必要最小限のメモリで開始

### インタラクション速度の改善

1. **バッチ更新の最適化**: `queueMicrotask` の代わりに `requestAnimationFrame` の検討
2. **DOM操作の最小化**: 差分更新アルゴリズムの改善
3. **WASM-JS間の呼び出し削減**: バッチ処理でブリッジオーバーヘッドを削減

## ビルドコマンド

```bash
# WASMをビルド（最適化済み）
bun run build:wasm

# JSをビルド
bun run build

# 型定義を生成
bun run build:types

# すべてをビルド
bun run prepare
```

## デバッグ用ビルド

開発時には、デバッグ情報を含むビルドを使用できます：

```bash
# デバッグビルド（最適化なし）
v -b wasm -o dist/vsignal.wasm src/vsignal/signal.v
```
